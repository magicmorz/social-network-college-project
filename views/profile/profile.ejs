<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      <%= targetUser.username %> (@<%= targetUser.username %>) ‚Ä¢ Instagram
    </title>
    <link rel="stylesheet" href="/styles/feed.css" />
    <link rel="stylesheet" href="/styles/theme.css" />
    <link rel="stylesheet" href="/styles/profile.css" />
    <link rel="icon" href="/utils/tab_instagram_icon.png" type="image/png" />
    <style>
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: white;
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        border-radius: 8px;
        display: flex;
        flex-direction: row;
      }
      .modal-media {
        flex: 1;
        max-width: 60%;
      }
      .modal-media img,
      .modal-media video {
        width: 100%;
        max-height: 600px;
        object-fit: contain;
      }
      .modal-details {
        flex: 1;
        padding: 20px;
        max-width: 40%;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .modal-header .username {
        font-weight: bold;
      }
      .modal-caption {
        margin-bottom: 20px;
      }
      .modal-comments {
        flex-grow: 1;
        overflow-y: auto;
        max-height: 300px;
        margin-bottom: 20px;
      }
      .modal-comment {
        display: flex;
        align-items: flex-start;
        margin-bottom: 10px;
      }
      .modal-comment img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .modal-comment .comment-content {
        flex-grow: 1;
      }
      .modal-actions {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .modal-actions button {
        background: none;
        border: none;
        cursor: pointer;
        margin-right: 15px;
      }
      .modal-actions .likes-count {
        font-weight: bold;
      }
      .modal-add-comment {
        display: flex;
        align-items: center;
      }
      .modal-add-comment input {
        flex-grow: 1;
        border: 1px solid #dbdbdb;
        border-radius: 4px;
        padding: 8px;
      }
      .modal-add-comment button {
        background: none;
        border: none;
        color: #0095f6;
        font-weight: bold;
        cursor: pointer;
        margin-left: 10px;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }
      .username-link {
        color: inherit;
        text-decoration: none;
        font-weight: bold;
      }
      .username-link:hover {
        text-decoration: underline;
      }
      .delete-post-btn:hover {
        background: darkred;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div class="logo">
            <a href="/home">
              <img src="/utils/Instagram_Image_2x.png" alt="Instagram" />
            </a>
          </div>
          <div class="header-actions">
            <a href="/home" class="back-to-feed">‚Üê Back to Feed</a>
            <span class="current-user">@<%= currentUser.username %></span>
          </div>
        </div>
      </header>

      <!-- Profile Content -->
      <main class="profile-container">
        <div class="profile-header">
          <div class="profile-avatar">
            <img
              src="/Uploads/user_<%= targetUser._id %>/profile_picture/profile.jpg"
              alt="<%= targetUser.username %>'s avatar"
              class="profile-img"
            />
            <% if (isOwnProfile) { %>
            <div class="avatar-upload-control">
              <button class="upload-avatar-btn" title="Upload new picture">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                  />
                  <circle cx="12" cy="13" r="4" />
                </svg>
              </button>
            </div>
            <% } %>
          </div>

          <div class="profile-info">
            <div class="profile-username">
              <h1><%= targetUser.username %></h1>
              <% if (targetUser.isVerified) { %>
              <span class="verified-badge">‚úì</span>
              <% } %> <% if (isOwnProfile) { %>
              <button class="edit-profile-btn">Edit profile</button>
              <a
                href="/u/<%= targetUser.username %>/insights"
                class="insights-btn"
                >üìä Insights</a
              >
              <% } else { %>
              <button
                class="follow-btn <%= isFollowing ? 'following' : '' %>"
                data-username="<%= targetUser.username %>"
                data-following="<%= isFollowing %>"
              >
                <%= isFollowing ? 'Following' : 'Follow' %>
              </button>
              <% } %>
            </div>

            <div class="profile-stats">
              <div class="stat">
                <span class="stat-number"><%= postsCount %></span>
                <span noviembre="stat-label">posts</span>
              </div>
              <div class="stat">
                <span class="stat-number follower-count"
                  ><%= followerCount %></span
                >
                <span class="stat-label">followers</span>
              </div>
              <div class="stat">
                <span class="stat-number"><%= followingCount %></span>
                <span class="stat-label">following</span>
              </div>
            </div>

            <div class="profile-bio">
              <% if (targetUser.bio) { %>
              <p><%= targetUser.bio %></p>
              <% } %> <% if (targetUser.country) { %>
              <p class="profile-country">üìç <%= targetUser.country %></p>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Posts Grid -->
        <div class="posts-section">
          <div class="posts-header">
            <h2>
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21,15 16,10 5,21" />
              </svg>
              POSTS
            </h2>
          </div>

          <% if (posts.length > 0) { %>
          <div class="posts-grid">
            <% posts.forEach(post => { %>
            <div
              class="post-thumbnail"
              data-post-id="<%= post._id %>"
              data-type="<%= post.type %>"
            >
              <% if (post.media) { %> <% const filename =
              post.media.split('/').pop(); %> <% if (post.type === 'image') { %>
              <img
                src="/Uploads/user_<%= post.user._id %>/posts/<%= encodeURIComponent(filename) %>"
                alt="Post by <%= post.user.username %>"
                class="post-media"
                onload="console.log('Image loaded successfully: ' + this.src)"
                onerror="console.error('Image failed to load: ' + this.src + '; Error: ' + (this.error ? this.error.message : 'Unknown error')); this.style.display='none'; this.nextElementSibling.style.display='block';"
              />
              <div
                class="media-error"
                style="display: none; color: red; text-align: center"
              >
                Image failed to load: <%= filename %>
              </div>
              <% } else if (post.type === 'video') { %>
              <video
                src="/Uploads/user_<%= post.user._id %>/posts/<%= encodeURIComponent(filename) %>"
                poster="/utils/video_placeholder.jpg"
                muted
                class="post-media"
                onloadstart="console.log('Video load started: ' + this.src)"
                onerror="console.error('Video failed to load: ' + this.src + '; Error: ' + (this.error ? this.error.message : 'Unknown error')); this.style.display='none'; this.nextElementSibling.style.display='block';"
              >
                <source
                  src="/Uploads/user_<%= post.user._id %>/posts/<%= encodeURIComponent(filename) %>"
                  type="video/mp4"
                />
                Your browser does not support the video tag.
              </video>
              <div
                class="media-error"
                style="display: none; color: red; text-align: center"
              >
                Video failed to load: <%= filename %>
              </div>
              <% } %> <% } else { %>
              <div class="post-text-preview">
                <p>
                  <%= post.caption.substring(0, 100) %><%= post.caption.length >
                  100 ? '...' : '' %>
                </p>
              </div>
              <% } %>
              <div class="post-overlay">
                <div class="post-stats">
                  <span class="likes-count">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="white"
                    >
                      <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                      />
                    </svg>
                    <%= post.likes ? post.likes.length : 0 %>
                  </span>
                  <span class="comments-count">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="white"
                    >
                      <path
                        d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                      />
                    </svg>
                    <%= post.comments ? post.comments.length : 0 %>
                  </span>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
          <% } else { %>
          <div class="no-posts">
            <div class="no-posts-icon">
              <svg
                width="62"
                height="62"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <circle cx="12" cy="12" r="3.2" />
                <path
                  d="M9 2L7.17 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-3.17L15 2H9z"
                />
              </svg>
            </div>
            <h3>No Posts Yet</h3>
            <% if (isOwnProfile) { %>
            <p>
              When you share photos and videos, they will appear on your
              profile.
            </p>
            <a href="/home" class="share-first-post">Share your first post</a>
            <% } else { %>
            <p><%= targetUser.username %> hasn't shared any posts yet.</p>
            <% } %>
          </div>
          <% } %>
        </div>
      </main>

      <!-- Post Modal -->
      <div class="modal" id="postModal">
        <div class="modal-content">
          <button class="close-btn" onclick="closeModal()">‚úï</button>
          <div class="modal-media"></div>
          <div class="modal-details">
            <div class="modal-header">
              <img src="" alt="User avatar" />
              <span class="username"></span>
              <span class="verified-badge" style="display: none">‚úì</span>
            </div>
            <div class="modal-caption"></div>
            <div class="modal-comments"></div>
            <div class="modal-actions">
              <button class="like-btn" data-liked="false">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5
                      0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78
                      1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                  />
                </svg>
              </button>
              <span class="likes-count">0 likes</span>
            </div>
            <div class="modal-add-comment">
              <input
                type="text"
                placeholder="Add a comment..."
                class="comment-input"
              />
              <button class="post-comment-btn" style="display: none">
                Post
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const followBtn = document.querySelector(".follow-btn");
        const modal = document.getElementById("postModal");
        const modalMedia = document.querySelector(".modal-media");
        const modalHeaderImg = document.querySelector(".modal-header img");
        const modalUsername = document.querySelector(".modal-header .username");
        const modalVerifiedBadge = document.querySelector(
          ".modal-header .verified-badge"
        );
        const modalCaption = document.querySelector(".modal-caption");
        const modalComments = document.querySelector(".modal-comments");
        const modalLikesCount = document.querySelector(
          ".modal-actions .likes-count"
        );
        const modalLikeBtn = document.querySelector(".modal-actions .like-btn");
        const commentInput = document.querySelector(
          ".modal-add-comment .comment-input"
        );
        const postCommentBtn = document.querySelector(
          ".modal-add-comment .post-comment-btn"
        );

        let currentPostId = null;

        // Follow/Unfollow functionality
        if (followBtn) {
          followBtn.addEventListener("click", async function () {
            const username = this.dataset.username;
            const isFollowing = this.dataset.following === "true";
            const action = isFollowing ? "unfollow" : "follow";

            try {
              this.disabled = true;
              this.textContent = isFollowing
                ? "Unfollowing..."
                : "Following...";

              const response = await fetch(`/u/${username}/${action}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
              });

              const data = await response.json();

              if (data.success) {
                this.dataset.following = data.isFollowing;
                this.textContent = data.isFollowing ? "Following" : "Follow";
                this.classList.toggle("following", data.isFollowing);
                const followerCountEl =
                  document.querySelector(".follower-count");
                if (followerCountEl) {
                  followerCountEl.textContent = data.followerCount;
                }
              } else {
                throw new Error(data.error || "Action failed");
              }
            } catch (error) {
              console.error("Follow/unfollow error:", error);
              alert("Error: " + error.message);
              this.textContent = isFollowing ? "Following" : "Follow";
            } finally {
              this.disabled = false;
            }
          });
        }

        // Post thumbnail click handlers
        document.querySelectorAll(".post-thumbnail").forEach((thumbnail) => {
          thumbnail.addEventListener("click", async function () {
            currentPostId = this.dataset.postId;
            console.log("Fetching post with ID:", currentPostId);
            try {
              const postResponse = await fetch(`/post/${currentPostId}`);
              if (!postResponse.ok) {
                console.error(
                  "Fetch post status:",
                  postResponse.status,
                  postResponse.statusText
                );
                const errorData = await postResponse.json().catch(() => ({}));
                console.error("Fetch post error:", errorData);
                throw new Error(errorData.error || "Failed to fetch post");
              }
              const postData = await postResponse.json();
              console.log("Post data:", postData);
              console.log("Media path:", postData.post.media);

              const commentsResponse = await fetch(
                `/post/${currentPostId}/comments`
              );
              if (!commentsResponse.ok) {
                console.error(
                  "Fetch comments status:",
                  commentsResponse.status,
                  commentsResponse.statusText
                );
                const errorData = await commentsResponse
                  .json()
                  .catch(() => ({}));
                console.error("Fetch comments error:", errorData);
                throw new Error(errorData.error || "Failed to fetch comments");
              }
              const commentsData = await commentsResponse.json();
              console.log("Comments data:", commentsData);

              modalMedia.innerHTML = "";
              modalComments.innerHTML = "";
              modalCaption.innerHTML = "";

              modalHeaderImg.src = `/Uploads/user_${postData.post.user._id}/profile_picture/profile.jpg`;
              modalUsername.innerHTML = `<a href="/u/${postData.post.user.username}" class="username-link">${postData.post.user.username}</a>`;
              modalVerifiedBadge.style.display = postData.post.user.isVerified
                ? "inline"
                : "none";

              if (postData.post.type === "image") {
                const imagePath = `/${postData.post.media.replace(
                  "uploads",
                  "Uploads"
                )}`;
                modalMedia.innerHTML = `
            <img src="${imagePath}" alt="Post image" onerror="console.error('Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';" />
            <div style="display: none; color: red; text-align: center;">Failed to load image</div>
          `;
              } else if (postData.post.type === "video") {
                const videoPath = `/${postData.post.media.replace(
                  "uploads",
                  "Uploads"
                )}`;
                modalMedia.innerHTML = `
            <video controls>
              <source src="${videoPath}" type="video/mp4" />
              Your browser does not support the video tag.
            </video>`;
              }

              if (postData.post.caption) {
                modalCaption.innerHTML = `
            <span><a href="/u/${postData.post.user.username}" class="username-link fw-bold">${postData.post.user.username}</a></span>
            <span>${postData.post.caption}</span>`;
              }

              // Add Delete Post button for post owner
              const isPostOwner =
                postData.post.user._id === "<%= currentUser._id %>";
              modalComments.innerHTML = isPostOwner
                ? `<button class="delete-post-btn" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; margin-bottom: 10px;">Delete Post</button>`
                : "";

              commentsData.comments.forEach((comment) => {
                const commentEl = document.createElement("div");
                commentEl.classList.add("modal-comment");
                commentEl.innerHTML = `
            <img src="/Uploads/user_${
              comment.user._id
            }/profile_picture/profile.jpg" alt="${comment.user.username}" />
            <div class="comment-content">
              <span class="fw-bold"><a href="/u/${
                comment.user.username
              }" class="username-link">${comment.user.username}</a></span>
              <span>${comment.text}</span>
              ${
                comment.gifUrl
                  ? `<img src="${comment.gifUrl}" alt="Comment GIF" style="max-width: 100px;" />`
                  : ""
              }
            </div>`;
                modalComments.appendChild(commentEl);
              });

              const userLikedPost = postData.post.likes.includes(
                "<%= currentUser._id %>"
              );
              modalLikeBtn.dataset.liked = userLikedPost;
              modalLikeBtn.innerHTML = userLikedPost
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="rgb(255,48,64)">
               <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
                 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09
                 1.09-1.28 2.76-2.09 4.5-2.09 3.08 0 5.5 2.42 5.5 5.5
                 0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
             </svg>`
                : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5
                 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78
                 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
             </svg>`;
              modalLikesCount.textContent = `${postData.post.likes.length} likes`;

              // Delete Post button handler
              if (isPostOwner) {
                const deleteBtn =
                  modalComments.querySelector(".delete-post-btn");
                deleteBtn.addEventListener("click", async function () {
                  if (!confirm("Are you sure you want to delete this post?"))
                    return;
                  try {
                    const response = await fetch(`/post/${currentPostId}`, {
                      method: "DELETE",
                      headers: {
                        "Content-Type": "application/json",
                      },
                    });
                    const data = await response.json();
                    if (data.success) {
                      // Remove post from DOM
                      const postElement = document
                        .querySelector(
                          `.post-thumbnail[data-post-id="${currentPostId}"]`
                        )
                        ?.closest(".post-container");
                      if (postElement) postElement.remove();
                      closeModal();
                    } else {
                      throw new Error(data.error || "Failed to delete post");
                    }
                  } catch (error) {
                    console.error("Delete post error:", error);
                    alert("Error: " + error.message);
                  }
                });
              }

              modal.style.display = "flex";
            } catch (error) {
              console.error("Error opening post:", error);
              alert("Error: " + error.message);
            }
          });
        });

        // Like/Unlike functionality
        modalLikeBtn.addEventListener("click", async function () {
          if (!currentPostId) return;

          try {
            const response = await fetch(`/post/${currentPostId}/like`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const data = await response.json();
            if (data.success) {
              this.dataset.liked = data.liked;
              this.innerHTML = data.liked
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="rgb(255,48,64)">
               <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
                 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09
                 1.09-1.28 2.76-2.09 4.5-2.09 3.08 0 5.5 2.42 5.5 5.5
                 0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
             </svg>`
                : `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5
                 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78
                 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
             </svg>`;
              modalLikesCount.textContent = `${data.likesCount} likes`;
            } else {
              throw new Error(data.error || "Failed to toggle like");
            }
          } catch (error) {
            console.error("Like/unlike error:", error);
            alert("Error: " + error.message);
          }
        });

        // Comment functionality
        commentInput.addEventListener("input", function () {
          postCommentBtn.style.display = this.value.trim() ? "block" : "none";
        });

        postCommentBtn.addEventListener("click", async function () {
          if (!currentPostId || !commentInput.value.trim()) return;

          try {
            const response = await fetch(`/post/${currentPostId}/comment`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ text: commentInput.value.trim() }),
            });

            const data = await response.json();
            if (data.success) {
              const commentEl = document.createElement("div");
              commentEl.classList.add("modal-comment");
              commentEl.innerHTML = `
          <img src="/Uploads/user_${data.comment.user._id}/profile_picture/profile.jpg" alt="${data.comment.user.username}" />
          <div class="comment-content">
            <span class="fw-bold"><a href="/u/${data.comment.user.username}" class="username-link">${data.comment.user.username}</a></span>
            <span>${data.comment.text}</span>
          </div>`;
              modalComments.appendChild(commentEl);
              commentInput.value = "";
              postCommentBtn.style.display = "none";
            } else {
              throw new Error(data.error || "Failed to add comment");
            }
          } catch (error) {
            console.error("Comment error:", error);
            alert("Error: " + error.message);
          }
        });

        // Modal close functionality
        window.closeModal = function () {
          modal.style.display = "none";
          currentPostId = null;
        };

        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            closeModal();
          }
        });
      });
    </script>
  </body>
</html>
